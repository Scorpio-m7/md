# 01-攻击流程

## 01-攻击流程

信息收集阶段->漏洞分析阶段->攻击阶段->后渗透阶段

## 02-信息收集

| ip资源          | 域名发现                 | 服务器信息收集   | 人力资源情报收集     | 网站关键信息识别 |
| --------------- | ------------------------ | ---------------- | -------------------- | ---------------- |
| 真实IP 获取     | 子域名信息收集           | 端口扫描         | whois信息            | 指纹识别         |
| 旁站信息收集    | 子域名枚举发现子域名     | 服务器版本识别   | 社会工程学           | 敏感路径探测     |
| C段主机信息收集 | 搜索引擎发现子域名       | 操作系统信息识别 | 利用客服进行信息收集 | 互联网信息收集   |
|                 | 第三方聚合服务发现子域名 |                  | 招聘信息收集         |                  |
|                 | 证书透明性信息发现子域名 |                  |                      |                  |
|                 | DNS域传送漏洞发现        |                  |                      |                  |

## 03-漏洞分析

- Exploit Database-利用数据库，收集了大量的漏洞以及漏洞利用程序
- Google hacking-利用google 搜索的语法进行精准的搜索
- Shodan-搜索连接到互联网的服务器、网络设备和摄像头等
- CVE/CNVD/CNNVD-搜索漏洞库，了解国内最新漏洞

## 04-攻击阶段

### 01-Web渗透测试

- CMS漏洞-WordPressCMS 漏洞、 DedeCMS 漏洞、Drupal 漏洞
- 框架漏洞-ThinkPHP框架漏洞、 Spring 框架漏洞、Struts2 框架漏洞
- Web TOP 10 漏洞-注入、文件上传、文件包含、命令执行、代码执行、XSS 、 SSRF 、 XXE 、反序列化、解析漏洞

### 02-权限提升

| Windows提权       | Linux提权        | 数据库提权            | 第三方提权       |
| ----------------- | ---------------- | --------------------- | ---------------- |
| 缓冲区溢出提权    | 内核漏洞提权     | SQL Server 数据库提权 | FTP软件提权      |
| 错误系统配置提权  | SUID提权         | MySQL UDF 提权        | 远程管理软件提权 |
| MSI文件提权       | 计划任务提权     | MySQL MOF 提权        |                  |
| 计划任务提权      | 环境变量劫持提权 | Oracle数据库提权      |                  |
| 启动项/组策略提权 |                  |                       |                  |
| 进程注入提权      |                  |                       |                  |

### 03-权限维持

| Windows权限维持 | Linux权限维持    | 渗透框架权限维持 | 其它方式维持   | 免杀技术      |
| --------------- | ---------------- | ---------------- | -------------- | ------------- |
| 隐藏系统用户    | sshd软连接       | Metasploit       | 远控NjRAT 木马 | 免杀工具      |
| shift 后门      | 启动项和计划任务 | Empire           | rootkit        | Cobalt Strike |
| 启动项          |                  | cobalt Strike    |                | Metasploit    |
| 计划任务        |                  |                  |                | 其他免杀方法  |
| 隐藏文件        |                  |                  |                |               |
| 创建服务        |                  |                  |                |               |

### 04-内网攻击

端口转发->反弹shell->代理客户端->隐秘隧道

| 中间人劫持攻击 | 网络设备漏洞 | 无线网攻击 | 操作系统漏洞  | 钓鱼攻击        |
| -------------- | ------------ | ---------- | ------------- | --------------- |
| Cookie会话劫持 | 路由器       | 无线网加密 | MS08-067 利用 | 邮件钓鱼        |
|                | 交换机       | 无线网破解 | MS17-010 利用 | CobalStrike钓鱼 |
|                |              |            |               | 重定向钓鱼      |

### 05-后渗透

| 敏感信息收集            | 本机信息收集 | 网络架构信息收集           | 域控攻击          | 域渗透/域控权限维持  |
| ----------------------- | ------------ | -------------------------- | ----------------- | -------------------- |
| 摄像头/LED 大屏信息收集 | 用户列表     | Netstat收集网络信息        | MS14-068攻击      | 黄金票据权限维持     |
| 共享目录信息收集        | 主机信息     | 路由表收集网络信息         | MS14-025攻击      | SSP权限维持          |
| 数据库信息收集          | 进程列表     | ICMP收集网络信息           | pass the key攻击  | 内存更新SSPs权限维持 |
| 高价值文档信息收集      | 端口列表     | Nbtscan收集网络信息        | pass the hash攻击 | GPO组策略权限维持    |
| 备份信息收集            | 补丁列表     | HOSTS文件收集网络信息      | ntml hash获取     |                      |
| SVN信息收集             | 用户习惯     | 登录日志收集网络信息       |                   |                      |
| Wiki信息收集            | 密码收集     | 代理服务器收集网络信息     |                   |                      |
| NFS信息收集             |              | 数据库配置文件收集网络信息 |                   |                      |

### 06-清除痕迹

| Windows日志痕迹清理    | Linux日志痕迹清理 | WEB日志痕迹清理     |
| ---------------------- | ----------------- | ------------------- |
| Metasploit 清除        | 历史记录清理      | Apache 日志痕迹清理 |
| Cobalt Strike 插件清理 | 日志清理          | IIS 日志痕迹清理    |

# 02-攻击路径

## 01-互联网 Web 应用系统攻击

- 访问网站
- 发现网站服务
- 查找cms相关漏洞
- 利用工具获取信息
- 查看是否可控
  - 是否存在文件上传点，文件名是否可控。
  - 是否存在备份数据库，数据库名是否可控。
  - 是否存在修改模板，修改内容是否可控。
  - 是否存在配置上传类型等选项。
  - 各种系统配置，如网站名、简介等。
- 获得网站控制权

## 02-互联网旁站攻击

- ip反查
  - 获取站点真实IP
  - 通过查询接口根据IP 反查绑定域名
  - 对旁站进行渗透并Getshell
  - 通过旁站的Shell 进行提权，获取服务器权限

## 03-互联网系统与服务攻击

### 01-常见服务端口号

| 端口号          | 端口服务/协议简要说明                 | 常见攻击手法                                                 |
| --------------- | ------------------------------------- | ------------------------------------------------------------ |
| TCP/20,21       | FTP-进行文件传输                      | 匿名上传下载文件、明文嗅探、弱口令暴力破解、VSFTP 后门、远程命令执行 |
| TCP/22          | SSH-linux 系统远程登录、 SSL 加密传输 | 弱口令暴力破解获得linux 系统远程登录权限                     |
| TCP/23          | Telnet-明文传输                       | 弱口令暴力破解、明文嗅探、交换机、路由器等设备远程登录权限   |
| TCP/25          | SMTP-简单邮件传输协议                 | 枚举邮箱用户、邮件伪造                                       |
| UDP/53          | DNS-域名解析                          | DNS劫持、域传送漏洞                                          |
| UDP/69          | TFTP-简单文件传输协议 文              | 文件下载                                                     |
| TCP/80,443,8080 | Web-常用 Web 服务端口                 | Web服务                                                      |
| TCP/110         | POP-邮局协议                          | 弱口令暴力破解、明文嗅探                                     |
| TCP/137,139,445 | Samba-Windows 和 Linux 间文件共享     | MS08-067 、 MS17-010 、弱口令暴力破解等                      |

### 02-常见端口

| TCP/1433 | MSSQL数据库         |
| -------- | ------------------- |
| TCP/1521 | Oracle数据库        |
| TCP/3306 | MySQL数据库         |
| TCP/3389 | Windows RDP远程桌面 |
| TCP/3690 | SVN服务             |
| TCP/5432 | PostgreSQL数据库    |

### 03-暴力破解

通过对公司外网IP的21 、 23 、 1433 、3389 、 8888 等端口进行暴力破解成功获得 3389 端口账号密码

### 04-远程连接桌面

通过上面暴力破解获取的用户名密码信息，连入远程桌面，这样就获取到了目标服务器的控制权

## 04-移动 APP 应用攻击

### Activity 公开组件暴露漏洞

利用反编译工具判断是否存在Activity 组件暴露的漏洞，反编译完成后发现 PWList Activity 的【 android:exported 】设置为了 true说明 PWList 这个 Activity 允许被外部程序调用，就可以利用此漏洞，对此 Activity 进行直接调用绕过了密码的验证，登录到了 APP 应用的后台页面，利用工具绕过密码验证，启动此Activity 组件

```bash
adb shell am start a action n com.mwr.example.sieve com.mwr.example.sieve.PWList
```

APP应用的功能与 APP 应用服务器的接口也可能会有交互，通过接口进行渗透也是常见的攻击方式。

## 05-社会工程学攻击

| 人员伪装 | 钓鱼短信     | 互联网公开信息检索 | 钓鱼WIFI | 钓鱼邮件     |
| -------- | ------------ | ------------------ | -------- | ------------ |
| 伪造工牌 | 中将短信     | 社工库检索         | 伪造WIFI | 广撒网式钓鱼 |
| 拨打电话 | 换号诈骗     | 搜索引擎检索       | WIFI攻击 | 鱼叉式钓鱼   |
|          | 伪装熟人短信 |                    |          | 水坑式钓鱼   |
|          |              |                    |          | 捕鲸式攻击   |

## 06-近源攻击

| ZigBee攻击     | 蓝牙攻击     | WIFI安全     | 物理攻击 | 人机接口攻击 |
| -------------- | ------------ | ------------ | -------- | ------------ |
| ZigBee攻击     | 蓝牙重放攻击 | 无线WIFI攻击 | 门锁攻击 | BadUSB       |
| ZigBee密钥攻击 | 蓝牙DDoS攻击 | WIFI钓鱼     | Hid攻击  | 键盘记录器   |
|                | 蓝牙MITM攻击 | 无人机攻击   |          | HDMI嗅探     |
|                | 蓝牙数据嗅探 | 无线设备攻击 |          |              |

## 07-供应链攻击

Xcode恶意代码植入

# 03-信息收集-IP资源

## 01-真实 IP 获取

### 01-CDN技术-内容分发网络

为了保证网络的稳定和快速传输，网站服务商会在网络的不同位置设置节点服务器，通过CDN 技术，将网络请求分发到最优的节点服务器上面。

### 02-判断CDN

- [站长工具](http://ping.chinaz.com)

- [爱站网](https://ping.aizhan.com)

- nslookup

  - 无CDN

    ```bash
    abc.com
    服务器: public1 .114dns.com
    Address: 114.114.114.114
    非权威应答:
    名称: abc.com
    Address: 192.12.168.172
    ```

  - 有CDN

    ```bash
    www .abc.com
    服务器: public1 .114dns.com
    Address: 114.114.114.114
    非权威应答:
    名称: abc.xdwscache.ourglb0.com
    Addresses: 58.223.164.86
    			125.75.32.252
    Aliases: www .abc.com
    		www.abc.com.lxdns.com
    ```

### 03-绕过CDN 获取真实 IP

#### 01-查询子域名

子域名可能跟主站在同一个服务器或者同一个 C 段网络中，可以通过子域名探测的方式，收集目标的子域名信息，通过查询子域名的 IP 信息来辅助判断主站的真实 IP 信息。

#### 02-查询历史DNS 记录

微步在线查询的【 www.***.com 】这个域名的历史 DNS 解析信息，然后分析哪些 IP 不在现在的 CDN 解析 IP 里面，就有可能是之前没有加 CDN 加速时的真实 IP

#### 03-使用国外主机解析域名

探测的方式也有两种，一种是利用自己已有的国外的主机直接进行探测，另一种如果没有国外主机可以利用公开的多地 ping 服务，多地 ping 服务有国外的探测节点，可以利用国外节点的返回信息来判断真实的 IP 信息。

#### 04-网站漏洞

利用网站存在的漏洞，信息泄露的敏感信息、文件，如 phpinfo文件、网站源码文件、Github 泄露的信息等都可能会将真实的 IP 信息泄露。

#### 05-邮件信息

邮件的信息中会记录邮件服务器的IP 信息，有些站点有类似于 RSS 邮件订阅可以发送邮件的功能，可以利用其发送的邮件，通过查看源码的方式查看真实服务器的 IP 信息。

## 02-旁站信息收集

旁站是与攻击目标在同一服务器上的不同网站，当攻击目标没有漏洞的情况下，可以通过查找旁站的漏洞，通过攻击旁站，然后再通过提权拿到服务器的最高权限 。

### 01-nmap功能

- 扫描主机端口，嗅探所提供的网络服务
- 探测一组主机是否在线
- 推断主机所用的操作系统

### 02-nmap作用

- 探测目标主机所开放的端口
- 通过识别新的服务器审计网络的安全性
- 探测网络上的主机
- 通过对设备或者防火墙的探测来审计它的安全性

### 03-全端口扫描

```bash
root@kali:~#nmap -sV -p 1-65535 192.168.88.21
```

### 04-第三方服务获取旁站信息

- [同IP 网站查询](http://stool.chinaz.com/same)
- Bing搜索

## 03-C 段主机信息收集

### 01-Nmap扫描

```bash
root@kali:~#nmap -sn 192.168.88.21/24
```

### 02-搜索引擎

在Google 搜索引擎中输入`site:61.x.162.*`

# 04-信息收集-服务器与人力资源情报收集

## 01-nmap

- Nmap进行指纹识别的参数`-sV`
- Nmap使用`-O`参数来启动操作系统检测

## 02-Whois 信息

- [站长之家](https://tool.chinaz.com/ipwhois)
- [who.is](https://who.is)
- [bugscaner](http://whois.bugscaner.com)

## 03-社会工程学

- 信息刺探
  1. 善用你身边的信息
  2. 学习侦探的伪装
  3. 人性的弱点
  4. 组织信息构造陷阱
- 心理学的应用
  - 冒用身份
  - 行为模仿
  - NPL内心存储记忆
- 反查技术
  - 在攻击中最重要的一部分不是成功侵入主机，而是清除痕迹，不要让管理者发现被侵入及数据被伪造。

## 04-利用招聘信息&客服进行信息收集

- 招聘网站信息收集
- 通过客服植入木马
- 官方联系方式招聘网站信息收集

# 05-信息收集-网站关键信息收集

## 01-指纹识别

| CMS信息 | 前端技术  | Web服务器 | WAF信息 | 开发语言 | 操作系统 |
| ------- | --------- | --------- | ------- | -------- | -------- |
| 织梦CMS | HTML5     | Apache    | Yundun  | PHP      | Kali     |
| 大汉CMS | jquery    | Tomcat    | Topsec  | JAVA     | Centos   |
| 帝国CMS | bootstrap | Nginx     | 安全狗  | Python   | Win7     |
| PhpCMS  | Prue      | IIS       |         | Ruby     | Ubuntu   |
| Ecshop  | Ace       | Jboss     |         | C#       | Win2003  |

### 01-特定关键字识别

- 访问网站的首页，从返回的信息Powered by DedeCMS
- 通过meta 标签中的 content 字段识别 WordPress 

### 02-特定文件及路径识别

- CMS会有一些 JS 、 CSS 、图片等静态文件，这些文件一般不会变化，可以利用这些特定文件的 MD5 值作为指纹信息来判断 CMS 的类型 。
- 不同的CMS 会有不同网站结构， WordPress 会有特定的文件路径`/wp-admin`，WordPress 和 DedeCMS 的`robots.txt`文件可能包含了 CMS 特定的文件路径，与扫描工具数据库存储的指纹信息进行正则匹配判断 CMS 的类型。

### 03-响应头信息识别

应用程序会在响应头Server 、 X Powered By 、 Set Cookie 等字段中返回 Banner 信息或者自定义的数据字段，通过响应头返回的信息，可以对应用进行识别，WAF 设备也可以通过响应头信息进行识别判断。当然应用程序可以自定义自己的 Banner 信息。

## 02-指纹识别工具

- whatweb
  - 常规扫描-whatweb 域名/ip地址
  - 批量扫描-whatweb -i 含有需要扫描的域名的文件的路径
  - 详细回显扫描-whatweb -v 域名
  - 本地扫描-whatweb --no-errors -t 255 内网网段
  - 扫描强度等级控制-whatweb -a 3 域名（只有1 3 两个级别）
  - 扫描结果导出文件-whatweb --log-xml= testfire.xml
- Wappalyzer
- Whatruns
- [W11scan](https://github.com/hannoch/w11scan)
- [云悉指纹识别](https://www.yunsee.cn/)

## 03-敏感路径探测

通过敏感路径探测可以获取很多由于错误配置泄露的文件、默认文件、测试文件、备份文件等，这些文件里面可能存在了很多数据库配置、应用程序配置等敏感信息。

- 使用BurpSuite 可以扫描目录， BurpSuite 有Intruder 模块，将抓到的数据包的路径设置为变量，将目录文件的字典添加为 Payload ，然后不断遍历达到目录暴力破解的目的。
- 将目录文件的字典添加为Payload ，注意将【 Payload Encoding 】去掉对勾，否则可能会将Payload 的 等特殊字符进行 URL 编码。
- 遍历完成字典中的路径后，对状态进行排序，状态码是 200 和 301 都是真实存在的路径 。

## 04-互联网信息收集

### 01-历史漏洞信息收集

ZoomEye给出各大组件、服务器系统等存在的历史性漏洞的描述文档

### 02-SVN代码泄漏

【.svn 】的【 pristine 】文件夹里包含了整个项目的所有文件备份。若发布代码时直接将整个项目拷贝到了网站根目录，并且没有删掉隐藏的【 svn 】文件，或是直接使用【 Checkout 】将项目拉到网站根目录发布站点，然后没有删除隐藏的【 .svn 】文件，将会导致 SVN代码泄露。

### 03-GIT代码泄漏使用

GIT也是一个版本控制软件 。使用工具 GitHack 利用 GIT 代码泄漏

### 04-网盘信息收集

为了文件的传输方便将代码或者其他含有敏感信息的文件传输到网盘中，如果将网盘中的文件进行了无密码分享或者网盘本身存在漏洞再或者是网盘的密码泄露，[网站1](http://hao.misiai.com)，[网站2](https://search.chongbuluo.com)

# 06-信息收集-域名发现

## 01-子域名信息收集

子域名是在域名系统等级中，属于更高一层域的域。比如， mail.example.com 和 calendar.example.com是 example.com 的两个子域。

- .ac用于科研机构
- .com用于工商金融企业
- .net用于互联网络信息中心和运行中心
- .org用于非营利组织

## 02-子域名枚举发现子域名

- Layer子域名挖掘机
- SubDomainsBrute
- DNSRecon
- Subbrute
- Recon-Ng
- Fierce
- Gobuster

## 03-搜索引擎发现子域名

> 搜索语法:site:xxx.com
>
> - google
> - baidu
> - bing
> - yahoo

## 04-第三方聚合服务发现子域名

很多公开的第三方聚合服务网站都可以进行信息收集，子域名信息是其包含的内容之一 。

- [DNSdumpster](https://dnsdumpster.com/)
- [VirusTotal](https://www.virustotal.com/gui/home/search)
- Sublist3r

## 05-证书透明性信息发现子域名

是Google 的公开项目，旨在通过让域所有者、 CA 和域用户对 SSL 证书的发行和存在进行审查，来纠正这些基于证书的威胁，在`https:// transparencyreport.google.com /https/certificates`中输入`***.com`进行搜索

## 06-DNS域传送漏洞发现子域名

- 主DNS 服务器
  - 主要维护所负责解析的域数据库的 DNS 服务器，可以对数据库进行读写操作，数据库中存储了主机名相关的信息，需要管理员手工进行修改。
- 从DNS 服务器
  - 作为主 DNS 服务器的备份服务器与负载服务器。
- 缓存DNS 服务器
  - 不负责域名解析，它会将用户访问其他 DNS 的信息保存在本地，作为缓存数据，这样用户再访问时就会比较方便，缩短域名的查询时间。
- 转发DNS 服务器
  - 将特定的域名查询进行转发转发 DNS 服务器会转发到指定的 DNS 服务器上面由此台指定的 DNS 服务器完成域名解析的工作 。

1. 在kali中使用`dig xxx.com ns`命令对目标发送一个 ns 类的解析请求判断其 dns 服务器。
2. 对目标发起axfr 请求成功获取到其域内的所有域名`dig axfr dns xxx.com`。
